pipeline {
    agent any
    
    tools {
        // ğŸ’¡ PASTIKAN: Nama 'MAVEN' sesuai dengan yang ada di 
        // Manage Jenkins -> Tools -> Global Tool Configuration
        maven 'MAVEN'
    }
    
    environment {
        // Variabel environment untuk Docker
        DOCKER_REGISTRY = 'your-registry'  // Ganti dengan registry Anda
        IMAGE_TAG = "${BUILD_NUMBER}"
    }
    
    stages {
        // ====== STAGE 1: CHECKOUT ======
        stage('Checkout') {
            steps {
                echo 'ğŸ“¥ Cloning repository...'
                checkout scm
            }
        }
        
        // ====== STAGE 2: BUILD ALL SERVICES (PARALLEL) ======
        stage('Build All Services') {
            parallel {
                stage('Build Anggota') {
                    steps {
                        echo 'ğŸ”¨ Building Anggota Service...'
                        dir('anggota') {
                            sh 'mvn clean package -DskipTests'
                        }
                    }
                }
                stage('Build Buku') {
                    steps {
                        echo 'ğŸ”¨ Building Buku Service...'
                        dir('buku') {
                            sh 'mvn clean package -DskipTests'
                        }
                    }
                }
                stage('Build Peminjaman') {
                    steps {
                        echo 'ğŸ”¨ Building Peminjaman Service...'
                        dir('peminjaman') {
                            sh 'mvn clean package -DskipTests'
                        }
                    }
                }
                stage('Build Pengembalian') {
                    steps {
                        echo 'ğŸ”¨ Building Pengembalian Service...'
                        dir('pengembalian') {
                            sh 'mvn clean package -DskipTests'
                        }
                    }
                }
            }
        }
        
        // ====== STAGE 3: TEST ALL SERVICES (PARALLEL) ======
        stage('Test All Services') {
            parallel {
                stage('Test Anggota') {
                    steps {
                        echo 'ğŸ§ª Testing Anggota Service...'
                        dir('anggota') {
                            sh 'mvn test'
                        }
                    }
                    post {
                        always {
                            junit allowEmptyResults: true, testResults: 'anggota/target/surefire-reports/*.xml'
                        }
                    }
                }
                stage('Test Buku') {
                    steps {
                        echo 'ğŸ§ª Testing Buku Service...'
                        dir('buku') {
                            sh 'mvn test'
                        }
                    }
                    post {
                        always {
                            junit allowEmptyResults: true, testResults: 'buku/target/surefire-reports/*.xml'
                        }
                    }
                }
                stage('Test Peminjaman') {
                    steps {
                        echo 'ğŸ§ª Testing Peminjaman Service...'
                        dir('peminjaman') {
                            sh 'mvn test'
                        }
                    }
                    post {
                        always {
                            junit allowEmptyResults: true, testResults: 'peminjaman/target/surefire-reports/*.xml'
                        }
                    }
                }
                stage('Test Pengembalian') {
                    steps {
                        echo 'ğŸ§ª Testing Pengembalian Service...'
                        dir('pengembalian') {
                            sh 'mvn test'
                        }
                    }
                    post {
                        always {
                            junit allowEmptyResults: true, testResults: 'pengembalian/target/surefire-reports/*.xml'
                        }
                    }
                }
            }
        }
        
        // ====== STAGE 4: BUILD DOCKER IMAGES ======
        stage('Build Docker Images') {
            steps {
                echo 'ğŸ³ Building Docker images...'
                script {
                    sh '''
                        docker compose build anggota-service
                        docker compose build buku-service
                        docker compose build peminjaman-service
                        docker compose build pengembalian-service
                    '''
                }
            }
        }
        
        // ====== STAGE 5: DEPLOY TO DOCKER ======
        stage('Deploy') {
            steps {
                echo 'ğŸš€ Deploying services...'
                script {
                    sh '''
                        docker compose up -d server-eureka
                        sleep 30
                        docker compose up -d rabbitmq
                        sleep 15
                        docker compose up -d anggota-service buku-service peminjaman-service pengembalian-service
                        sleep 30
                        docker compose up -d api-gateway
                    '''
                }
            }
        }
        
        // ====== STAGE 6: HEALTH CHECK ======
        stage('Health Check') {
            steps {
                echo 'ğŸ¥ Checking service health...'
                script {
                    sh '''
                        sleep 30
                        echo "Checking Anggota Service..."
                        curl -f http://anggota-service:8081/actuator/health || exit 1
                        echo "Checking Buku Service..."
                        curl -f http://buku-service:8082/actuator/health || exit 1
                        echo "Checking Peminjaman Service..."
                        curl -f http://peminjaman-service:8083/actuator/health || exit 1
                        echo "Checking Pengembalian Service..."
                        curl -f http://pengembalian-service:8084/actuator/health || exit 1
                        echo "âœ… All services are healthy!"
                    '''
                }
            }
        }
    }
    
    post {
        success {
            echo '''
            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            âœ… PIPELINE SUCCESSFUL!
            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            
            All 4 microservices have been built, tested, and deployed:
               âœ… Anggota Service    â†’ http://localhost:8081
               âœ… Buku Service       â†’ http://localhost:8082
               âœ… Peminjaman Service â†’ http://localhost:8083
               âœ… Pengembalian Service â†’ http://localhost:8084
            
            ğŸ“Š Monitoring:
               â€¢ Eureka Dashboard   â†’ http://localhost:8761
               â€¢ RabbitMQ UI        â†’ http://localhost:15672
               â€¢ Prometheus         â†’ http://localhost:9090
               â€¢ Grafana            â†’ http://localhost:3000
               â€¢ Kibana             â†’ http://localhost:5601
            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            '''
        }
        failure {
            echo '''
            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            âŒ PIPELINE FAILED!
            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            Check the console output above for error details.
            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            '''
        }
        always {
            echo "ğŸ”„ Pipeline completed at: ${new Date().format('yyyy-MM-dd HH:mm:ss')}"
            // Cleanup workspace (optional)
            // cleanWs()
        }
    }
}
